# Архитектура улучшенного планировщика пути для дрона

## Общая архитектура системы

Планировщик пути для дрона состоит из нескольких взаимодействующих компонентов:

```
                  +------------------+
                  |  Карта (map_server) |
                  +--------+---------+
                           |
          +----------------v-----------------+
          |      Глобальный планировщик      |
          | (global_planner.py + move_base)  |
          +----------------+-----------------+
                           |
                           v
          +----------------+-----------------+
          |      Локальный планировщик       |
          |        (local_planner.py)        |
          +----------------+-----------------+
                           |
                           v
          +----------------+-----------------+
          |    Конвертер пути в setpoints    |
          |       (path_to_setpoint.py)      |
          +----------------+-----------------+
                           |
                           v
          +----------------+-----------------+
          |           MAVROS                 |
          |  (интерфейс к полетному контроллеру) |
          +----------------+-----------------+
                           |
                           v
          +----------------+-----------------+
          |       ArduPilot SITL            |
          |   (полетный контроллер дрона)    |
          +----------------+-----------------+
                           |
                           v
          +----------------+-----------------+
          |           Gazebo                 |
          |        (симуляция физики)        |
          +----------------------------------+
```

## Подробное описание компонентов

### 1. Глобальный планировщик (global_planner.py)

Глобальный планировщик отвечает за построение маршрута от текущей позиции дрона до целевой точки, учитывая известную карту окружения.

**Основные функции:**
- Получение целевой точки от RViz или других источников
- Получение текущей позиции дрона через TF
- Планирование маршрута с учетом карты и препятствий
- Визуализация пути с помощью маркеров в RViz

**Алгоритм планирования:**
- Используется простой алгоритм планирования для демонстрации (линейная интерполяция)
- Предусмотрена возможность замены на полноценный A* или другие алгоритмы поиска пути
- Учитывается карта препятствий (costmap) от move_base

**Интеграция:**
- Работает параллельно с глобальным планировщиком move_base
- Публикует путь в формате nav_msgs/Path для использования другими компонентами

### 2. Локальный планировщик (local_planner.py)

Локальный планировщик обеспечивает безопасное движение дрона, реагируя на динамические препятствия в реальном времени.

**Основные функции:**
- Получение данных с лидара для обнаружения препятствий
- Следование по глобальному пути
- Динамическое избегание препятствий
- Генерация команд управления (cmd_vel)

**Алгоритм избегания препятствий:**
- Анализ секторов вокруг дрона для обнаружения препятствий
- Вычисление направления объезда с использованием весовой функции
- Балансировка между следованием по пути и избеганием препятствий
- Адаптивное изменение скорости в зависимости от близости препятствий

**Интеграция:**
- Получает глобальный план от глобального планировщика
- Публикует команды скорости для дрона (cmd_vel)
- Визуализирует локальный план для отладки

### 3. Модуль path_to_setpoint.py

Этот модуль преобразует плановый путь в команды для MAVROS, который управляет дроном.

**Основные функции:**
- Подписка на топики с плановым путем
- Последовательное следование по точкам пути
- Отслеживание прогресса достижения точек
- Публикация setpoint-команд для MAVROS

**Алгоритм следования по пути:**
- Выбор текущей целевой точки из плана
- Определение момента достижения точки по расстоянию
- Плавный переход между точками
- Обработка завершения пути

**Интеграция:**
- Получает путь от глобального планировщика
- Публикует позиционные setpoint-команды для MAVROS
- Управляет режимом полета (GUIDED) и армированием дрона

### 4. Вспомогательные компоненты

#### map_to_odom.py
Обеспечивает трансформацию между системами координат map и odom, что необходимо для работы навигационного стека ROS.

#### Конфигурационные файлы
- **local_planner_params.yaml**: Параметры локального планировщика
- **costmap_params.yaml**: Настройки карты стоимости для move_base
- **base_local_planner.yaml**: Настройки встроенного планировщика траекторий
- **recovery_behaviors.yaml**: Поведение восстановления при ошибках навигации

## Принцип работы системы

1. **Инициализация**:
   - Запуск симуляции Gazebo с моделью дрона
   - Запуск ArduPilot SITL для симуляции полетного контроллера
   - Запуск узлов ROS через launch-файл improved_nav.launch

2. **Планирование маршрута**:
   - Пользователь указывает целевую точку в RViz
   - Глобальный планировщик строит путь от текущей позиции к цели
   - Путь визуализируется в RViz для проверки

3. **Выполнение маршрута**:
   - Локальный планировщик обрабатывает глобальный план
   - Модуль path_to_setpoint преобразует план в команды MAVROS
   - Дрон следует по пути, избегая препятствия
   - Локальный планировщик корректирует движение на основе данных лидара

4. **Мониторинг и контроль**:
   - RViz отображает текущее положение, план и карту
   - Логи узлов показывают статус выполнения
   - Консоль ArduPilot показывает состояние полетного контроллера

## Преимущества архитектуры

1. **Модульность**: Каждый компонент может быть заменен или улучшен независимо
2. **Расширяемость**: Легко добавить новые алгоритмы планирования или избегания препятствий
3. **Интеграция**: Использование стандартных интерфейсов ROS для взаимодействия компонентов
4. **Визуализация**: Полная визуализация в RViz для отладки и мониторинга
5. **Надежность**: Независимое функционирование компонентов повышает отказоустойчивость

## Дальнейшие улучшения

1. **Улучшенные алгоритмы планирования**:
   - Реализация полноценного A* с эвристикой для 3D-пространства
   - Интеграция RRT или других современных алгоритмов

2. **Динамическое перепланирование**:
   - Автоматическое перепланирование при обнаружении новых препятствий
   - Адаптивное следование по пути с учетом динамики дрона

3. **Обработка данных сенсоров**:
   - Интеграция данных с камеры для распознавания объектов
   - Фильтрация данных лидара для улучшения обнаружения препятствий

4. **Оптимизация производительности**:
   - Оптимизация алгоритмов для работы в реальном времени
   - Балансировка нагрузки между компонентами 